<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>WebPlayer</title>
<link rel="stylesheet" type="text/css" href="WebForm.css" />
<script src="../view/lib/jquery-3.2.1.min.js"></script>
<script src="WinAPI.js"></script>
<script src="Binder.js"></script>
<script>
Binder.prototype.startResizeWindow = function(type) {
	this._.startResizeWindow(type);
}
Binder.prototype.setTime = function(time) {
	this._.setTime(time);
}
Binder.prototype.openFileDialog = function() {
	this._.openFileDialog();
}
Binder.prototype.close = function() {
	this._.close();
}
</script>
<script src="WebForm.js"></script>
<script>
// 팟플레이어 SDK 값 가져옴
const WM_USER = 0x0400;
const POT_COMMAND = WM_USER;
const POT_GET_CURRENT_TIME = 0x5004;
const POT_SET_CURRENT_TIME = 0x5005;
const POT_SET_PLAY_STATUS  = 0x5007;
const POT_SET_PLAY_CLOSE   = 0x5009;
const POT_GET_VIDEO_FPS    = 0x6032;

wndProc = function(m) {
	switch (m.wParam) {
		case POT_SET_PLAY_STATUS : {
			return main.mainView.contentWindow.setStatus(m.lParam);
		}
		case POT_SET_PLAY_CLOSE : {
			return main.mainView.contentWindow.stop();
		}
		case POT_GET_CURRENT_TIME: {
			return main.time;
		}
		case POT_SET_CURRENT_TIME: {
			return main.mainView.contentWindow.moveTo(m.lParam);
		}
		case POT_GET_VIDEO_FPS   : {
			return 0;
		}
		case 0x0010: {
			window.close();
			break;
		}
	}
};

window.main = new WebForm();
{	// main
	main.run = function() {
		this.initializeComponent();
		
		main.mainView.src = "../view/WebPlayer.html";
		main.mainView.onload = function() {
			// 브라우저 샘플에선 url 변형 필요
			main.mainView.contentWindow._open_ = main.mainView.contentWindow.open;
			main.mainView.contentWindow.open = function(url, name, options) {
				if (url.substring(0, 4) != "http") {
					url = location.href.substring(0, location.href.lastIndexOf("/")) + "/view/" + url;
				}
				return main.windows[name] = window_open(url, name, options, main.mainView.contentWindow);
			}
			
			main.mainView.contentWindow.binder = main.binder = new Binder(main);
			
			const cd = main.mainView.contentDocument;
			cd.addEventListener("dragenter", (e) => {
				e.preventDefault();
				main.showDragging();
			});
			
			main.mainView.contentWindow.afterReady();
		};
	}
}
{
	main.startResizeWindow = function(type) {
		// 웹샘플에서는 창 조절 별도 구현 없이 기본 조작에 의존
		main.script("endResize");
	}
	main.time = 0;
	main.setTime = function(time) {
		main.time = time;
	}
}
{
	main.files = {};
	main.openFileByDrag = function() {
		if (!this.droppedFiles) return;
		if (this.droppedFiles.length < 1) {
			this.droppedFiles = null;
			return;
		}
		this.openFile(this.droppedFiles[0]);
	}
	main.openFileDialog = async function(type, withSaveSkf, withKf) {
		const setting = { types: [{ description: '동영상 파일', accept: { 'video/*': ['.avi', '.mkv', '.mp4', '.ts', '.m2ts'] } }] };
		const fb = await window.showOpenFilePicker(setting);
		if (fb && fb[0]) {
			main.openFile(await fb[0].getFile());
		}
	}
	main.openFile = async function(file) {
		main.mainView.contentWindow.openFile(file);
		this.droppedFiles = null;
	}
	
	main.close = function() {
		window.close();
	}
}
ready(() => {
	main.run();
});
</script>
<style>
* {
	margin: 0;
	padding: 0;
	box-sizing: border-box;
}
html, body {
	width: 100%;
	height: 100%;
	border: 0;
	overflow: hidden;
}
</style>
</head>
<body></body>
</html>