<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>찾기/바꾸기</title>
<script src="lib/popup.js"></script>
<script>
windowName = "finder";
let styleSizePreset = "";

function init(last) {
	last = JSON.parse(last);
	const inputFind    = document.querySelector("[name=find]"   ); inputFind   .value = last.find   ; inputFind   .setSelectionRange(0, last.find   .length);
	const inputReplace = document.querySelector("[name=replace]"); inputReplace.value = last.replace; inputReplace.setSelectionRange(0, last.replace.length);
	document.querySelector("[name=case]").checked = last.withCase;
	document.querySelectorAll("[name=direction]")[last.reverse ? 0 : 1].click();
	document.querySelector(last.toFocus).focus();
}

function getParams() {
	const params = {};
	params.find      = document.querySelector("[name=find]"     ).value;
	params.replace   = document.querySelector("[name=replace]"  ).value;
	params.withCase  = document.querySelector("[name=case]"     ).checked;
	params.reverse   = document.querySelector("[name=direction]").checked;
	return JSON.stringify(params);
}

function setSize(size) {
	document.getElementById("styleSize").innerHTML = (styleSizePreset.replaceAll("20px", (20 * size) + "px"));
}

ready(() => {
	document.addEventListener("keydown", (e) => {
		const textarea = e.target.closest("textarea");
		if (textarea) {
			if (e.key == "Enter") {
				if (!e.shiftKey && !e.altKey) {
					e.preventDefault();
					if (e.ctrlKey) {
						let cursor = [textarea.selectionStart, textarea.selectionEnd];
						textarea.value = textarea.value.substring(0, cursor[0]) + "\n" + textarea.value.substring(cursor[1]);
						cursor = cursor[0] + 1;
						textarea.setSelectionRange(cursor, cursor);
					} else {
						if (textarea.name == "find") {
							document.getElementById("btnFind").click()
						} else if (textarea.name == "replace") {
							document.getElementById("btnReplace").click()
						}
					}
				}
			} else if (e.ctrlKey) {
				if (e.key != "a"
				 && e.key != "c"
				 && e.key != "v"
				 && e.key != "x") {
					// 기본 복붙 동작 제외하곤 차단
					e.preventDefault();
				}
			}
		}
	});
	
	styleSizePreset = document.getElementById("styleSize").innerHTML;
	
	if (window.binder) {
		document.getElementById("btnFind"      ).addEventListener("click", () => { binder.runFind      (getParams()); });
		document.getElementById("btnReplace"   ).addEventListener("click", () => { binder.runReplace   (getParams()); });
		document.getElementById("btnReplaceAll").addEventListener("click", () => { binder.runReplaceAll(getParams()); });
		binder.onloadFinder();
	} else {
		if (opener) {
			if (opener.SmiEditor && opener.SmiEditor.Finder) {
				document.getElementById("btnFind"      ).addEventListener("click", () => { opener.SmiEditor.Finder.runFind      (getParams()); });
				document.getElementById("btnReplace"   ).addEventListener("click", () => { opener.SmiEditor.Finder.runReplace   (getParams()); });
				document.getElementById("btnReplaceAll").addEventListener("click", () => { opener.SmiEditor.Finder.runReplaceAll(getParams()); });
				opener.SmiEditor.Finder.onload();
			}
		} else {
			setTimeout(() => {
				// iframe 기반인 경우 opener가 나중에 생김
				if (opener) {
					if (opener.SmiEditor && opener.SmiEditor.Finder) {
						document.getElementById("btnFind"      ).addEventListener("click", () => { opener.SmiEditor.Finder.runFind      (getParams()); });
						document.getElementById("btnReplace"   ).addEventListener("click", () => { opener.SmiEditor.Finder.runReplace   (getParams()); });
						document.getElementById("btnReplaceAll").addEventListener("click", () => { opener.SmiEditor.Finder.runReplaceAll(getParams()); });
						opener.SmiEditor.Finder.onload();
					}
				}
			}, 1);
		}
	}
});
</script>
<style>
#labelFind,
#labelFind > span,
#labelReplace,
#labelReplace > span,
#labelCase {
	display: block;
	position: absolute;
}
textarea, button, fieldset {
	position: absolute;
}
</style>
<style id="styleSize">
* {
	font-size: calc(20px * 0.6);
}
input, textarea, button {
	font-size: calc(20px * 0.6);
	line-height: calc(20px * 0.7);
	padding: 0 calc(20px * 0.1);
}
#labelFind, #labelReplace {
	left: calc(20px * 0.4);
	right: calc(20px * 5.8);
	height: calc(20px * 3);
}
#labelFind {
	top: calc(20px * 0.4);
}
#labelReplace {
	top: calc(20px * 3.9);
}
textarea {
	left: calc(20px * 3.8);
	right: 0;
	height: calc(20px * 3);
	resize: none;
}
#btnFind,
#btnReplace {
	right: calc(20px * 0.4);
	width: calc(20px * 5);
	height: calc(20px * 1.7);
}
#btnFind {
	top: calc(20px * 0.4);
}
#btnReplace {
	top: calc(20px * 2.5);
}
#btnReplaceAll {
	top: calc(20px * 4.6);
	right: calc(20px * 0.4);
	width: calc(20px * 5);
	height: calc(20px * 2.2);
}
#labelCase {
	top: calc(20px * 7.8);
	left: 20px;
}
#fieldsetDirection {
	top: calc(20px * 7);
	right: calc(20px * 5.8);
	padding: calc(20px * 0.2) calc(20px * 0.3);
}
</style>
</head>
<body>
	<form class="modal-main">
		<label id="labelFind">
			<span>찾을 내용(<u>N</u>)</span>
			<textarea name="find" accesskey="N" placeholder="줄바꿈 = Ctrl+Enter"></textarea>
		</label>
		<button type="button" class="button-find" accesskey="F" id="btnFind">찾기(<u>F</u>)</button>
		<label id="labelReplace">
			<span>바꿀 내용(<u>P</u>)</span>
			<textarea name="replace" accesskey="P" placeholder="줄바꿈 = Ctrl+Enter"></textarea>
		</label>
		<button type="button" class="button-replace" accesskey="R" id="btnReplace">바꾸기(<u>R</u>)</button>
		<button type="button" class="button-replace-all" accesskey="A" id="btnReplaceAll">모두 바꾸기(<u>A</u>)</button>
		<label id="labelCase">
			<input type="checkbox" name="case" accesskey="C" />
			<span>대소문자 구분(<u>C</u>)</span>
		</label>
		<fieldset id="fieldsetDirection">
			<legend>방향</legend>
			<label>
				<input type="radio" name="direction" value="-1" accesskey="U" />
				<span>위로(<u>U</u>)</span>
			</label>
			<label>
				<input type="radio" name="direction" value="1" accesskey="D" checked />
				<span>아래로(<u>D</u>)</span>
			</label>
		</fieldset>
	</form>
</body>
</html>